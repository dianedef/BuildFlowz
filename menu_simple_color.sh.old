#!/bin/bash

# Menu Ultra-Simple - Version Texte Pure
# Menu fonctionnel sans dÃ©pendances graphiques

# Load shared library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib.sh"

# Fonction d'affichage avec couleurs
print_header() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC}                ${YELLOW}DevServer Menu${NC}               ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•‘${NC}           ${BLUE}Development Environment${NC}          ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Fonction d'affichage du menu
show_menu() {
    echo -e "${BLUE}ğŸ“Š OVERVIEW${NC}"
    echo -e "  ${CYAN}1)${NC} Dashboard - View all environments at once"
    echo ""
    echo -e "${BLUE}ğŸš€ MANAGE${NC}"
    echo -e "  ${CYAN}2)${NC} Start/Deploy - Launch or deploy environment"
    echo -e "  ${CYAN}3)${NC} Restart - Restart an environment"
    echo -e "  ${CYAN}4)${NC} Stop - Stop an environment"
    echo -e "  ${CYAN}5)${NC} Remove - Delete an environment"
    echo ""
    echo -e "${BLUE}ğŸŒ PUBLISHING${NC}"
    echo -e "  ${CYAN}6)${NC} Publish to Web - Configure HTTPS (Caddy + DuckDNS)"
    echo ""
    echo -e "${BLUE}âš™ï¸  ADVANCED${NC}"
    echo -e "  ${CYAN}7)${NC} More Options - Logs, Navigate, Settings..."
    echo ""
    echo -e "  ${CYAN}0)${NC} Exit"
    echo ""
}

# Fonction de saisie
input() {
    local prompt="$1"
    local default="$2"
    echo -e "${YELLOW}$prompt${NC} \c"
    read -r result
    echo "${result:-$default}"
}

# Fonction de sÃ©lection d'environnement
select_environment() {
    local prompt_text="${1:-SÃ©lectionnez un environnement}"

    ALL_ENVS=$(list_all_environments)

    if [ -z "$ALL_ENVS" ]; then
        echo -e "${RED}âŒ Aucun environnement trouvÃ©${NC}"
        return 1
    fi

    echo -e "${BLUE}$prompt_text :${NC}"
    echo ""

    i=1
    while IFS= read -r env; do
        echo -e "  ${CYAN}$i)${NC} $env"
        ((i++))
    done <<< "$ALL_ENVS"

    echo ""
    echo -e "  ${CYAN}0)${NC} Annuler"
    echo ""
    echo -e "${YELLOW}Choisissez un numÃ©ro (0-$((i-1))) :${NC} \c"
    read -r choice

    if [[ "$choice" == "0" ]]; then
        return 1
    elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le $((i-1)) ]; then
        echo "$ALL_ENVS" | sed -n "${choice}p"
        return 0
    else
        echo -e "${RED}âŒ Choix invalide${NC}"
        return 1
    fi
}

# Fonction principale
main() {
    # Check prerequisites on first run
    if ! check_prerequisites; then
        exit 1
    fi

    # Nettoyer les projets orphelins au dÃ©marrage
    cleanup_orphan_projects

    while true; do
        clear
        print_header
        show_menu

        echo -e "${YELLOW}Votre choix :${NC} \c"
        read -r CHOICE

        case $CHOICE in
            1)
                echo -e "${GREEN}ğŸ“ Navigation dans /root${NC}"
                FOLDERS=$(find /root -maxdepth 1 -type d ! -name ".*" ! -path /root | sort)

                if [ -z "$FOLDERS" ]; then
                    echo -e "${RED}âŒ Aucun dossier trouvÃ©${NC}"
                else
                    echo -e "${BLUE}Dossiers disponibles :${NC}"
                    echo ""
                    i=1
                    while IFS= read -r folder; do
                        echo -e "  ${CYAN}$i)${NC} $folder"
                        ((i++))
                    done <<< "$FOLDERS"
                    echo ""
                    echo -e "${YELLOW}Choisissez un numÃ©ro (1-$((i-1))) :${NC} \c"
                    read -r choice

                    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le $((i-1)) ]; then
                        SELECTED=$(echo "$FOLDERS" | sed -n "${choice}p")
                        echo -e "${GREEN}ğŸ“ Dossier sÃ©lectionnÃ© : $SELECTED${NC}"
                        echo -e "${CYAN}Commande : cd $SELECTED${NC}"
                        echo -e "${GREEN}Ouverture du shell...${NC}"
                        cd "$SELECTED" && exec $SHELL
                    else
                        echo -e "${RED}âŒ Choix invalide${NC}"
                    fi
                fi
                ;;
            2)
                echo -e "${GREEN}ğŸ“‹ Environnements actifs et URLs${NC}"
                echo "Chargement..."
                sleep 0.5

                ALL_ENVS=$(list_all_environments)
                
                if [ -z "$ALL_ENVS" ]; then
                    echo -e "${RED}âŒ Aucun environnement trouvÃ©${NC}"
                else
                    echo ""
                    while IFS= read -r name; do
                        pm2_status=$(get_pm2_status "$name")
                        PROJECT_DIR=$(resolve_project_path "$name")
                        
                        # Afficher le statut avec la bonne couleur
                        case "$pm2_status" in
                            "online")
                                echo -e "${GREEN}ğŸŸ¢ [ONLINE] $name${NC}"
                                ;;
                            "stopped")
                                echo -e "${YELLOW}ğŸŸ¡ [STOPPED] $name${NC}"
                                ;;
                            "errored"|"error")
                                echo -e "${RED}ğŸ”´ [ERROR] $name${NC}"
                                ;;
                            "pm2-not-installed")
                                echo -e "${RED}âŒ [PM2 NOT INSTALLED] $name${NC}"
                                ;;
                            "not-found")
                                echo -e "${CYAN}âšª [NOT-FOUND] $name${NC}"
                                ;;
                            *)
                                echo -e "${CYAN}âšª [${pm2_status^^}] $name${NC}"
                                ;;
                        esac
                        
                        # Afficher le rÃ©pertoire du projet
                        if [ -n "$PROJECT_DIR" ]; then
                            echo -e "${BLUE}   ğŸ“‚ $PROJECT_DIR${NC}"
                            
                            # Afficher si environnement Flox prÃ©sent
                            if [ -d "$PROJECT_DIR/.flox" ]; then
                                echo -e "${GREEN}   âœ… Flox activÃ©${NC}"
                            fi
                        fi
                        
                        # Afficher le port et URL si disponible
                        local port=$(get_port_from_pm2 "$name")
                        if [ -n "$port" ]; then
                            echo -e "${CYAN}   ğŸ”Œ Port: $port${NC}"
                            echo -e "${CYAN}   ğŸŒ URL: http://localhost:$port${NC}"
                        fi
                        echo ""
                    done <<< "$ALL_ENVS"
                fi
                ;;
            3)
                echo -e "${GREEN}ğŸ›‘ Stopper un environnement${NC}"
                ALL_ENVS=$(list_all_environments)

                if [ -z "$ALL_ENVS" ]; then
                    echo -e "${RED}âŒ Aucun environnement trouvÃ©${NC}"
                else
                    echo -e "${BLUE}Environnements Ã  arrÃªter :${NC}"
                    echo ""
                    i=1
                    while IFS= read -r env; do
                        echo -e "  ${CYAN}$i)${NC} $env"
                        ((i++))
                    done <<< "$ALL_ENVS"
                    echo ""
                    echo -e "  ${CYAN}0)${NC} Annuler"
                    echo ""
                    echo -e "${YELLOW}Choisissez un numÃ©ro (0-$((i-1))) :${NC} \c"
                    read -r choice

                    if [[ "$choice" == "0" ]]; then
                        echo -e "${BLUE}âŒ AnnulÃ©${NC}"
                    elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le $((i-1)) ]; then
                        ENV_NAME=$(echo "$ALL_ENVS" | sed -n "${choice}p")

                        echo -e "${YELLOW}ğŸ›‘ ArrÃªt de $ENV_NAME...${NC}"
                        env_stop "$ENV_NAME"
                        echo -e "${GREEN}âœ… Environnement $ENV_NAME arrÃªtÃ© !${NC}"
                    else
                        echo -e "${RED}âŒ Choix invalide${NC}"
                    fi
                fi
                ;;
            4)
                echo -e "${GREEN}ğŸ“ Ouvrir le rÃ©pertoire de code${NC}"
                ALL_ENVS=$(list_all_environments)

                if [ -z "$ALL_ENVS" ]; then
                    echo -e "${RED}âŒ Aucun environnement trouvÃ©${NC}"
                else
                    echo -e "${BLUE}Environnements disponibles :${NC}"
                    echo ""
                    i=1
                    while IFS= read -r env; do
                        echo -e "  ${CYAN}$i)${NC} $env"
                        ((i++))
                    done <<< "$ALL_ENVS"
                    echo ""
                    echo -e "${YELLOW}Choisissez un numÃ©ro (1-$((i-1))) :${NC} \c"
                    read -r choice

                    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le $((i-1)) ]; then
                        ENV_NAME=$(echo "$ALL_ENVS" | sed -n "${choice}p")
                        PROJECT_DIR=$(resolve_project_path "$ENV_NAME")

                        if [ -z "$PROJECT_DIR" ]; then
                            echo -e "${RED}âŒ RÃ©pertoire introuvable : $ENV_NAME${NC}"
                        else
                            echo -e "${GREEN}ğŸ“‚ RÃ©pertoire du projet : $PROJECT_DIR${NC}"
                            echo -e "${GREEN}Ouverture du shell...${NC}"
                            cd "$PROJECT_DIR" && exec $SHELL
                        fi
                    else
                        echo -e "${RED}âŒ Choix invalide${NC}"
                    fi
                fi
                ;;
            5)
                echo -e "${GREEN}ğŸš€ DÃ©ployer un repo GitHub${NC}"
                echo "FonctionnalitÃ© disponible ! ğŸš€"

                # Lister les repos GitHub
                echo ""
                echo -e "${BLUE}ğŸ” Recherche de vos repos GitHub...${NC}"
                echo ""

                GITHUB_REPOS=$(list_github_repos)

                if [ -z "$GITHUB_REPOS" ]; then
                    continue
                fi

                echo -e "${GREEN}Repos disponibles :${NC}"
                echo ""
                i=1
                while IFS= read -r repo; do
                    echo -e "  ${CYAN}$i)${NC} $repo"
                    ((i++))
                done <<< "$GITHUB_REPOS"
                echo ""
                echo -e "${YELLOW}Choisissez un numÃ©ro (1-$((i-1))) :${NC} \c"
                read -r choice

                if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le $((i-1)) ]; then
                    SELECTED_REPO=$(echo "$GITHUB_REPOS" | sed -n "${choice}p" | cut -d':' -f1)

                    # Validate repo name
                    if ! validate_repo_name "$SELECTED_REPO"; then
                        echo -e "${RED}âŒ Invalid repository name${NC}"
                        continue
                    fi

                    echo ""
                    echo -e "${GREEN}ğŸ“¦ Repo sÃ©lectionnÃ© : $SELECTED_REPO${NC}"
                    echo -e "${BLUE}ğŸš€ DÃ©ploiement en cours...${NC}"
                    echo ""

                    # Nom du projet = nom du repo (sans timestamp)
                    PROJECT_NAME="${SELECTED_REPO,,}"
                    PROJECT_DIR="$PROJECTS_DIR/$PROJECT_NAME"

                    # VÃ©rifier si le projet existe dÃ©jÃ 
                    EXISTING_PROJECT_PATH=$(resolve_project_path "$PROJECT_NAME")
                    if [ -n "$EXISTING_PROJECT_PATH" ]; then
                        echo -e "${YELLOW}âš ï¸  Le projet $PROJECT_NAME existe dÃ©jÃ  Ã  $EXISTING_PROJECT_PATH${NC}"
                        echo -e "${YELLOW}Voulez-vous le remplacer ? (o/N) :${NC} \c"
                        read -r confirm
                        if [[ ! "$confirm" =~ ^[oO]$ ]]; then
                            echo -e "${BLUE}âŒ AnnulÃ©${NC}"
                            continue
                        fi
                        # Supprimer l'ancien projet
                        env_remove "$PROJECT_NAME"
                    fi

                    echo -e "${YELLOW}CrÃ©ation du projet $PROJECT_NAME...${NC}"
                    mkdir -p "$PROJECT_DIR"

                    # Cloner le repo
                    GITHUB_USER=$(get_github_username)
                    echo -e "${YELLOW}Clonage du repo https://github.com/$GITHUB_USER/$SELECTED_REPO...${NC}"
                    if git clone "https://github.com/$GITHUB_USER/$SELECTED_REPO.git" "$PROJECT_DIR"; then
                        echo -e "${GREEN}âœ… Repo clonÃ© avec succÃ¨s${NC}"
                    else
                        echo -e "${RED}âŒ Erreur lors du clonage${NC}"
                        rm -rf "$PROJECT_DIR"
                        continue
                    fi

                    # Initialiser l'environnement Flox
                    echo ""
                    echo -e "${YELLOW}ğŸ”§ Initialisation de l'environnement Flox...${NC}"
                    if ! init_flox_env "$PROJECT_DIR" "$PROJECT_NAME"; then
                        echo -e "${RED}âŒ Ã‰chec de l'initialisation Flox${NC}"
                        rm -rf "$PROJECT_DIR"
                        continue
                    fi

                    # DÃ©marrer l'environnement
                    echo ""
                    echo -e "${GREEN}ğŸš€ DÃ©marrage du projet...${NC}"
                    env_start "$PROJECT_NAME"
                    
                    PORT=$(get_port_from_pm2 "$PROJECT_NAME")
                    
                    echo ""
                    echo -e "${GREEN}âœ… DÃ©ploiement rÃ©ussi !${NC}"
                    echo ""
                    
                    if [ -n "$PORT" ]; then
                        echo -e "${BLUE}ğŸŒ URLs disponibles :${NC}"
                        echo -e "  â€¢ ${CYAN}http://localhost:${PORT}${NC}"
                        echo ""
                    fi
                    
                    echo -e "${YELLOW}ğŸ“ Code disponible dans : $PROJECT_DIR${NC}"
                else
                    echo -e "${RED}âŒ Choix invalide${NC}"
                fi
                ;;
            6)
                echo -e "${GREEN}ğŸ—‘ï¸  Supprimer un environnement${NC}"
                ALL_ENVS=$(list_all_environments)

                if [ -z "$ALL_ENVS" ]; then
                    echo -e "${RED}âŒ Aucun environnement trouvÃ©${NC}"
                else
                    echo -e "${BLUE}Environnements disponibles :${NC}"
                    echo ""
                    i=1
                    while IFS= read -r env; do
                        echo -e "  ${CYAN}$i)${NC} $env"
                        ((i++))
                    done <<< "$ALL_ENVS"
                    echo ""
                    echo -e "  ${CYAN}0)${NC} Annuler"
                    echo ""
                    echo -e "${YELLOW}Choisissez un numÃ©ro (0-$((i-1))) :${NC} \c"
                    read -r choice

                    if [[ "$choice" == "0" ]]; then
                        echo -e "${BLUE}âŒ AnnulÃ©${NC}"
                    elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le $((i-1)) ]; then
                        ENV_NAME=$(echo "$ALL_ENVS" | sed -n "${choice}p")

                        echo ""
                        echo -e "${RED}âš ï¸  ATTENTION : Cette action est irrÃ©versible !${NC}"
                        echo -e "${YELLOW}Projet : $ENV_NAME${NC}"
                        PROJECT_DIR=$(resolve_project_path "$ENV_NAME")
                        echo -e "${YELLOW}Dossier : $PROJECT_DIR${NC}"
                        echo ""

                        env_remove "$ENV_NAME"
                        echo ""
                        echo -e "${GREEN}âœ… Projet $ENV_NAME supprimÃ© avec succÃ¨s !${NC}"
                    else
                        echo -e "${RED}âŒ Choix invalide${NC}"
                    fi
                fi
                ;;

            7)
                echo -e "${GREEN}â–¶ï¸  DÃ©marrer un environnement (dÃ©tectÃ©)${NC}"
                ALL_ENVS=$(list_all_environments)

                if [ -z "$ALL_ENVS" ]; then
                    echo -e "${RED}âŒ Aucun environnement trouvÃ©${NC}"
                else
                    echo -e "${BLUE}Environnements disponibles :${NC}"
                    echo ""
                    i=1
                    while IFS= read -r env; do
                        echo -e "  ${CYAN}$i)${NC} $env"
                        ((i++))
                    done <<< "$ALL_ENVS"
                    echo ""
                    echo -e "  ${CYAN}0)${NC} Annuler"
                    echo ""
                    echo -e "${YELLOW}Choisissez un numÃ©ro (0-$((i-1))) :${NC} \c"
                    read -r choice

                    if [[ "$choice" == "0" ]]; then
                        echo -e "${BLUE}âŒ AnnulÃ©${NC}"
                    elif [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le $((i-1)) ]; then
                        ENV_NAME=$(echo "$ALL_ENVS" | sed -n "${choice}p")
                        
                        echo -e "${GREEN}â–¶ï¸  DÃ©marrage du projet $ENV_NAME...${NC}"

                        env_start "$ENV_NAME"
                        
                        echo ""
                        echo -e "${GREEN}âœ… Projet dÃ©marrÃ© avec succÃ¨s !${NC}"
                        echo ""
                        
                        PROJECT_DIR=$(resolve_project_path "$ENV_NAME")
                        if [ -n "$PROJECT_DIR" ]; then
                            PORT=$(get_port_from_pm2 "$(basename "$PROJECT_DIR")")
                            if [ -n "$PORT" ]; then
                                echo -e "${BLUE}ğŸŒ URLs disponibles :${NC}"
                                echo -e "  â€¢ ${CYAN}http://localhost:${PORT}${NC}"
                            else
                                echo -e "${YELLOW}  âš ï¸  Port non assignÃ© ou non dÃ©tectÃ©${NC}"
                            fi
                            echo ""
                            echo -e "${YELLOW}ğŸ“ Code disponible dans : $PROJECT_DIR${NC}"
                        else
                            echo -e "${RED}âŒ Impossible de rÃ©soudre le rÃ©pertoire du projet pour $ENV_NAME${NC}"
                        fi

                    else
                        echo -e "${RED}âŒ Choix invalide${NC}"
                    fi
                fi
                ;;

            8)
                echo -e "${GREEN}â–¶ï¸  DÃ©marrer un environnement (chemin personnalisÃ©)${NC}"
                echo ""
                echo -e "${YELLOW}Entrez le chemin absolu du projet (ex: /root/my-robots/chatbot) :${NC} \c"
                read -r CUSTOM_PATH

                if [ -z "$CUSTOM_PATH" ]; then
                    echo -e "${RED}âŒ Chemin requis${NC}"
                elif ! validate_project_path "$CUSTOM_PATH"; then
                    # Error already displayed by validate_project_path
                    :
                else
                    echo -e "${GREEN}â–¶ï¸  DÃ©marrage du projet Ã  partir de $CUSTOM_PATH...${NC}"
                    env_start "$CUSTOM_PATH"
                    echo ""
                    echo -e "${GREEN}âœ… Projet dÃ©marrÃ© avec succÃ¨s ou mis Ã  jour !${NC}"
                    
                    PROJECT_DIR=$(resolve_project_path "$CUSTOM_PATH")
                    if [ -n "$PROJECT_DIR" ]; then
                        ENV_NAME=$(basename "$PROJECT_DIR") # This assumes project name is the last part of the path
                        PORT=$(get_port_from_pm2 "$ENV_NAME")
                        if [ -n "$PORT" ]; then
                            echo -e "${BLUE}ğŸŒ URLs disponibles :${NC}"
                            echo -e "  â€¢ ${CYAN}http://localhost:${PORT}${NC}"
                        else
                            echo -e "${YELLOW}  âš ï¸  Port non assignÃ© ou non dÃ©tectÃ©${NC}"
                        fi
                        echo ""
                        echo -e "${YELLOW}ğŸ“ Code disponible dans : $PROJECT_DIR${NC}"
                    else
                        echo -e "${RED}âŒ Impossible de rÃ©soudre le rÃ©pertoire du projet pour $CUSTOM_PATH${NC}"
                    fi
                fi
                ;;

            9)
                echo -e "${GREEN}ğŸŒ Publier sur le web${NC}"
                echo ""
                
                # VÃ©rifier Caddy
                if ! command -v caddy &> /dev/null; then
                    echo -e "${RED}âŒ Caddy n'est pas installÃ©${NC}"
                    echo -e "${YELLOW}Lancez: sudo ./install.sh${NC}"
                    continue
                fi
                
                # VÃ©rifier PM2
                if ! command -v pm2 &> /dev/null; then
                    echo -e "${RED}âŒ PM2 n'est pas installÃ©${NC}"
                    continue
                fi
                
                # RÃ©cupÃ©rer l'IP publique
                echo -e "${BLUE}ğŸ” DÃ©tection de l'IP publique...${NC}"
                PUBLIC_IP=$(curl -4 -s https://ip.me 2>/dev/null)
                if [ -z "$PUBLIC_IP" ]; then
                    echo -e "${RED}âŒ Impossible de rÃ©cupÃ©rer l'IP publique${NC}"
                    continue
                fi
                
                echo -e "${GREEN}âœ… IP publique dÃ©tectÃ©e: $PUBLIC_IP${NC}"
                echo ""
                
                # Demander le sous-domaine DuckDNS
                echo -e "${CYAN}ğŸ¦† Configuration DuckDNS${NC}"
                echo ""
                echo -e "${BLUE}Votre URL sera: votresubdomain.duckdns.org${NC}"
                echo -e "${YELLOW}CrÃ©ez un compte gratuit sur https://www.duckdns.org${NC}"
                echo ""
                
                echo -e "${YELLOW}Sous-domaine DuckDNS (ex: demo, dev) :${NC} \c"
                read -r SUBDOMAIN
                if [ -z "$SUBDOMAIN" ]; then
                    echo -e "${RED}âŒ Sous-domaine requis${NC}"
                    continue
                fi
                
                echo ""
                echo -e "${YELLOW}Token DuckDNS :${NC} \c"
                read -rs TOKEN
                echo ""
                if [ -z "$TOKEN" ]; then
                    echo -e "${RED}âŒ Token requis${NC}"
                    continue
                fi
                
                echo ""
                echo -e "${BLUE}ğŸ“¡ Mise Ã  jour DuckDNS...${NC}"
                DUCKDNS_RESPONSE=$(curl -s "https://www.duckdns.org/update?domains=$SUBDOMAIN&token=$TOKEN&ip=$PUBLIC_IP")
                
                if [ "$DUCKDNS_RESPONSE" != "OK" ]; then
                    echo -e "${RED}âŒ Erreur DuckDNS: $DUCKDNS_RESPONSE${NC}"
                    echo -e "${YELLOW}VÃ©rifiez votre sous-domaine et token${NC}"
                    continue
                fi
                
                echo -e "${GREEN}âœ… DuckDNS configurÃ©: $SUBDOMAIN.duckdns.org â†’ $PUBLIC_IP${NC}"
                echo ""
                
                # RÃ©cupÃ©rer les ports PM2
                echo -e "${BLUE}ğŸ“¡ DÃ©tection des applications PM2...${NC}"
                APPS=$(pm2 jlist 2>/dev/null | python3 -c "
import sys, json
try:
    apps = json.load(sys.stdin)
    for app in apps:
        if app['pm2_env']['status'] == 'online':
            env = app['pm2_env'].get('env', {})
            port = env.get('PORT') or env.get('port')
            if port:
                name = app['name']
                print(f'{name}:{port}')
except:
    pass
" 2>/dev/null)
                
                if [ -z "$APPS" ]; then
                    echo -e "${RED}âŒ Aucune application PM2 trouvÃ©e${NC}"
                    continue
                fi
                
                # GÃ©nÃ©rer le Caddyfile
                CADDYFILE="/etc/caddy/Caddyfile"
                echo -e "${BLUE}ğŸ“ GÃ©nÃ©ration de la configuration Caddy...${NC}"
                
                # Backup de l'ancien fichier
                if [ -f "$CADDYFILE" ]; then
                    sudo cp "$CADDYFILE" "${CADDYFILE}.backup.$(date +%s)"
                fi
                
                # CrÃ©er le nouveau Caddyfile
                {
                    echo "# Auto-gÃ©nÃ©rÃ© par BuildFlowz - $(date)"
                    echo ""
                    
                    echo "$APPS" | while IFS=: read -r name port; do
                        echo "${SUBDOMAIN}.duckdns.org/${name} {"
                        echo "    reverse_proxy localhost:${port}"
                        echo "}"
                        echo ""
                    done
                } | sudo tee "$CADDYFILE" > /dev/null
                
                # Recharger Caddy
                echo -e "${BLUE}ğŸ”„ Rechargement de Caddy...${NC}"
                if sudo systemctl reload caddy 2>/dev/null || sudo caddy reload --config "$CADDYFILE" 2>/dev/null; then
                    echo -e "${GREEN}âœ… Caddy configurÃ© et rechargÃ©${NC}"
                else
                    echo -e "${YELLOW}âš ï¸  Erreur lors du rechargement de Caddy${NC}"
                    echo -e "${YELLOW}Configuration sauvegardÃ©e dans $CADDYFILE${NC}"
                fi
                
                echo ""
                echo -e "${GREEN}ğŸŒ URLs disponibles:${NC}"
                echo ""
                
                echo "$APPS" | while IFS=: read -r name port; do
                    echo -e "  ${CYAN}âœ“ https://${SUBDOMAIN}.duckdns.org/${name}${NC}"
                done
                
                echo ""
                echo -e "${YELLOW}âš ï¸  Note: Le certificat HTTPS peut prendre quelques minutes${NC}"
                ;;

            10)
                echo -e "${GREEN}ğŸ‘‹ Au revoir !${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}âŒ Option invalide${NC}"
                ;;
        esac

        echo ""
        echo -e "${YELLOW}Appuyez sur EntrÃ©e pour continuer...${NC}"
        read -r
    done
}


# Lancer le menu
main